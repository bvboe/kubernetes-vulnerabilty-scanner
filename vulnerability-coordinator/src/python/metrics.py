from vulnerability_coordinator import RUNNING_CONTAINER_CACHE
from file_manager import load_vulnerability_scan, load_scan_status, load_sbom
import os

CLUSTER_NAME=os.getenv("CLUSTER_NAME")

def generate_standard_property_string():
    #Todo - rewrite to handle more properties in the future
    return "cluster_name=\"" + CLUSTER_NAME + "\""

def gauge_map_to_string(name, gauge_map, property_keys):
    #print(f"gauge_map_to_string({name}, ...)")
    result = []
    for key_tuple, value in gauge_map.items():
        property_string = generate_standard_property_string()
        for property_key, property_value in zip(property_keys, key_tuple):
            property_string = property_string + ", " + property_key + "=\"" + property_value + "\""
        gauge_item = name + "{" + property_string + "} " + str(value)
        result.append(gauge_item)

    return result

def increment_map_counter(map, key):
    if key in map:
        counter = map[key]
        counter = counter + 1
        map[key] = counter
    else:
        map[key] = 1

def generate_metrics():
    print("generate_metrics")

    container_instances_gauge_map = {}
    full_vulnerability_gauge_map = {}
    sbom_gauge_map = {}
    
    for container, container_image in RUNNING_CONTAINER_CACHE.get_copy().items():
        namespace = container.namespace
        image = container_image.image
        image_id = container_image.image_id
        scan_status = load_scan_status(image_id)
        cluster_name_namespace = CLUSTER_NAME + "." + namespace
        cluster_name_namespace_image = cluster_name_namespace + "." + image
        cluster_name_namespace_image_id = cluster_name_namespace + "." + image_id
        if scan_status == "COMPLETE":
            container_instance_gauge_key = (
                cluster_name_namespace,
                cluster_name_namespace_image,
                cluster_name_namespace_image_id,
                namespace,
                image,
                image_id
            )
            increment_map_counter(container_instances_gauge_map, container_instance_gauge_key)

            vulnerability_scan = load_vulnerability_scan(image_id)
            for scan_item in vulnerability_scan:
                vulnerability_id = scan_item['vulnerability']['id']
                severity = scan_item['vulnerability']['severity']
                fix_state = scan_item['vulnerability']['fix']['state']

                full_vulnerability_scan_key = (
                    cluster_name_namespace,
                    cluster_name_namespace_image,
                    cluster_name_namespace_image_id,
                    namespace,
                    image,
                    image_id,
                    vulnerability_id,
                    severity,
                    fix_state
                )
                increment_map_counter(full_vulnerability_gauge_map, full_vulnerability_scan_key)

            sbom = load_sbom(image_id)
            for sbom_item in sbom:
                name = sbom_item['name']
                version = sbom_item['version']
                type = sbom_item['type']
                sbom_key = (
                    cluster_name_namespace,
                    cluster_name_namespace_image,
                    cluster_name_namespace_image_id,
                    namespace,
                    name,
                    version,
                    type
                )
                increment_map_counter(sbom_gauge_map, sbom_key)

    result = []
    result.extend(gauge_map_to_string("kubernetes_vulnerability_scanned_containers", container_instances_gauge_map, (
        "cluster_name_namespace",
        "cluster_name_namespace_image",
        "cluster_name_namespace_image_id",
        "namespace", 
        "image",
        "image_id"
        )))
    result.extend(gauge_map_to_string("kubernetes_vulnerability_results", full_vulnerability_gauge_map, (
        "cluster_name_namespace",
        "cluster_name_namespace_image",
        "cluster_name_namespace_image_id",
        "namespace", 
        "image", 
        "image_id",
        "vulnerability_id", 
        "severity", 
        "fix_state"
        )))
    result.extend(gauge_map_to_string("kubernetes_vulnerability_sbom", sbom_gauge_map, (
        "cluster_name_namespace",
        "cluster_name_namespace_image",
        "cluster_name_namespace_image_id",
        "namespace", 
        "name", 
        "version", 
        "type"
        )))
    return result
    