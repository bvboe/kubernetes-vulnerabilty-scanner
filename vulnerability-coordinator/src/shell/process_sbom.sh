#!/bin/bash
#Exit the script if one of the commands fail
set -e
SCAN_DIRECTORY=$1
echo Scan directory: $SCAN_DIRECTORY
echo "./process_sbom.sh $SCAN_DIRECTORY"
date
cd $SCAN_DIRECTORY

SBOM=sbom.json

echo Check if sbom is there
if [[ ! -e "$SBOM" || ! -s "$SBOM" ]]; then
  echo "SBMOM file $SBOM doesn't exist, returning"
  exit 1
fi

SBOM_SHORT=sbom-short.json
SBOM_SUMMARY_FILE=sbom-summary.json
VULNERABILITY_SCAN_FULL=vulnerability-scan-full.json
VULNERABILITY_SCAN_SHORT=vulnerability-scan-short.json
VULNERABILITY_SCAN_SUMMARY=vulnerability-scan-summary.json
METADATA=metadata.json
STATUS=status.txt

rm -fr tmp
mkdir tmp
cd tmp
cp ../$SBOM .
echo Write temporary status, just in case something fails
echo -n "SCAN_FAILED" > $STATUS

echo Rum vulnerability scan on SBOM $SBOM
grype sbom:$SBOM --output json >  $VULNERABILITY_SCAN_FULL

echo Generate compact SBOM
cat $SBOM | \
    jq '.artifacts | map (
                    {
                        name: .name,
                        version: .version,
                        type: .type
                    }
                    )' > $SBOM_SHORT

number_of_packages=`cat $SBOM_SHORT | jq -c '.[]' | wc -l`
distro=`cat $SBOM | jq -c '.distro'`
package_statistics=`cat $SBOM_SHORT | jq 'sort_by(.type) | group_by(.type) | map({type: .[0].type, count: length})'`

echo Generate SBOM summary
sbom_summary="{\"number_of_packages\": $number_of_packages, \"package_statistics\": $package_statistics, \"distro\": $distro}"
echo $sbom_summary | jq > $SBOM_SUMMARY_FILE

echo Generate compact vulnerability list
cat $VULNERABILITY_SCAN_FULL | \
    jq '.matches | map(
                    {
                        artifact: {
                            name: .artifact.name,
                            version: .artifact.version,
                            type: .artifact.type
                        },
                        vulnerability: {
                            id: .vulnerability.id,
                            severity: .vulnerability.severity,
                            fix: .vulnerability.fix
                        }
                    }
                    )' | jq 'unique' > $VULNERABILITY_SCAN_SHORT

echo Generate vulnerability summary
vulnerability_statistics=`jq 'sort_by(.artifact.type, .vulnerability.severity, .vulnerability.fix.state) |
    group_by(.artifact.type, .vulnerability.severity, .vulnerability.fix.state) |
    map({
        type: .[0].artifact.type,
        severity: .[0].vulnerability.severity,
        state: .[0].vulnerability.fix.state,
        count: length
    })' $VULNERABILITY_SCAN_SHORT`

critical_cves=`jq '[.[] | select(.vulnerability.severity == "Critical")] | length' $VULNERABILITY_SCAN_SHORT`
high_cves=`jq '[.[] | select(.vulnerability.severity == "High")] | length' $VULNERABILITY_SCAN_SHORT`
medium_cves=`jq '[.[] | select(.vulnerability.severity == "Medium")] | length' $VULNERABILITY_SCAN_SHORT`
low_cves=`jq '[.[] | select(.vulnerability.severity == "Low")] | length' $VULNERABILITY_SCAN_SHORT`
negligible_cves=`jq '[.[] | select(.vulnerability.severity == "Negligible")] | length' $VULNERABILITY_SCAN_SHORT`
unknown_cves=`jq '[.[] | select(.vulnerability.severity == "Unknown")] | length' $VULNERABILITY_SCAN_SHORT`

status_fixed=`jq '[.[] | select(.vulnerability.fix.state == "fixed")] | length' $VULNERABILITY_SCAN_SHORT`
status_not_fixed=`jq '[.[] | select(.vulnerability.fix.state == "not-fixed")] | length' $VULNERABILITY_SCAN_SHORT`
status_wont_fix=`jq '[.[] | select(.vulnerability.fix.state == "wont-fix")] | length' $VULNERABILITY_SCAN_SHORT`
status_unknown=`jq '[.[] | select(.vulnerability.fix.state == "unknown")] | length' $VULNERABILITY_SCAN_SHORT`

vulnerability_summary="{ \"by_severity\": {
                            \"critical\": $critical_cves,
                            \"high\": $high_cves,
                            \"medium\": $medium_cves,
                            \"low\": $low_cves,
                            \"negligible\": $negligible_cves,
                            \"unknown\": $unknown_cves
                        },
                        \"by_status\": {
                            \"fixed\": $status_fixed,
                            \"not_fixed\": $status_not_fixed,
                            \"wont_fix\": $status_wont_fix,
                            \"unknown\": $status_unknown
                        },
                        \"number_of_packages\": $number_of_packages,
                        \"vulnerability_statistics\": $vulnerability_statistics}"

echo $vulnerability_summary | jq > $VULNERABILITY_SCAN_SUMMARY

echo Generate Scan Metadata
cat $SBOM_SHORT | jq '{ "unique-packages": ([.[] | .type] | unique | sort) }' > $METADATA
severities=`cat $VULNERABILITY_SCAN_SHORT | jq '[.[] | .vulnerability.severity] | unique | sort'`
jq --argjson moredata "$severities" '. + {"severities": $moredata}' $METADATA > tmp.json && mv tmp.json $METADATA
fixstates=`cat $VULNERABILITY_SCAN_SHORT | jq '[.[] | .vulnerability.fix.state] | unique | sort'`
jq --argjson moredata "$fixstates" '. + {"fix-states": $moredata}' $METADATA > tmp.json && mv tmp.json $METADATA

echo Done, copying back result
echo -n "COMPLETE" > $STATUS
mv * ..
cd ..
rm -fr tmp

echo Done!
